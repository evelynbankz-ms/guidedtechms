<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin â€” Support Tickets</title>
<link rel="shortcut icon" href="../asset/logo-icon.png">
<link rel="stylesheet" href="admin.css">
<link rel="stylesheet" href="tickets.css">
<link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet"/>
</head>
<body>
<div class="admin-wrap">

  <!-- TOP BAR -->
  <header class="admin-topbar">
    <div class="brand">
      <div class="logo">G</div>
      Guided Tech Admin
    </div>
  </header>

  <div class="admin-grid">

    <!-- SIDEBAR -->
    <aside class="admin-side">
      <nav class="side-nav">
        <a href="dashboard.html">Dashboard</a>
        <a href="blog.html">Blog Posts</a>
        <a href="casestudy.html">Case Study</a>
        <a href="team.html">Team Members</a>
        <a href="faq.html">FAQs</a>
        <a href="testimonials.html">Testimonials</a>
        <a href="careers.html">Careers</a>
        <a href="tickets.html" class="active">Tickets</a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="admin-main tickets-page">

      <!-- STAT BAR -->
      <div class="stats-grid">
        <div class="stat-card" id="statCardTotal">
          <h4>Total</h4><span id="statTotal">0</span>
        </div>
        <div class="stat-card open" id="statCardOpen">
          <h4>Open</h4><span id="statOpen">0</span>
        </div>
        <div class="stat-card pending" id="statCardPending">
          <h4>Pending</h4><span id="statPending">0</span>
        </div>
        <div class="stat-card closed" id="statCardClosed">
          <h4>Closed</h4><span id="statClosed">0</span>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="ticket-toolbar">
        <div class="toolbar-left">
          <select id="statusFilter" class="tb-select">
            <option value="">All Tickets</option>
            <option value="open">Open</option>
            <option value="pending">Pending</option>
            <option value="closed">Closed</option>
          </select>
          <select id="sortFilter" class="tb-select">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="name">By Name</option>
          </select>
          <input id="searchInput" class="tb-search" type="text" placeholder="Search ticketsâ€¦"/>
        </div>
        <div class="toolbar-right">
          <button class="tb-btn" id="mergeBtn" title="Merge selected tickets" disabled>
            â¤´ Merge
          </button>
          <button class="tb-btn tb-btn-primary" id="refreshBtn" title="Refresh">
            â†» Refresh
          </button>
        </div>
      </div>

      <!-- THREE-PANEL WORKSPACE -->
      <div class="workspace" id="workspace">

        <!-- â”€â”€ PANEL A: Ticket List â”€â”€ -->
        <div class="panel panel-list" id="panelList">
          <div class="panel-list-inner" id="ticketList"></div>
        </div>

        <!-- DRAG HANDLE: list â†” detail -->
        <div class="resizer" id="resizerLD" title="Drag to resize"></div>

        <!-- â”€â”€ PANEL B: Ticket Detail â”€â”€ -->
        <div class="panel panel-detail" id="panelDetail">

          <!-- EMPTY STATE -->
          <div class="td-empty" id="ticketEmpty">
            <div class="td-empty-icon">ðŸ“­</div>
            <p>Select a ticket to view the conversation</p>
          </div>

          <!-- DETAIL CONTENT (hidden until ticket selected) -->
          <div class="td-content" id="tdContent" style="display:none">

            <!-- DETAIL HEADER -->
            <div class="td-header" id="tdHeader">
              <div class="td-header-top">
                <div class="td-header-left">
                  <h2 id="ticketSubject" class="td-subject"></h2>
                  <p id="ticketMeta" class="td-meta"></p>
                </div>
                <div class="td-header-right">
                  <select id="ticketStatus" class="status-select">
                    <option value="open">Open</option>
                    <option value="pending">Pending</option>
                    <option value="closed">Closed</option>
                  </select>
                  <div class="td-actions">
                    <button class="icon-btn" id="mergeTicketBtn" title="Merge with another ticket">â¤´ Merge</button>
                    <button class="icon-btn danger" id="closeTicketBtn" title="Close this ticket">âœ• Close</button>
                  </div>
                </div>
              </div>

              <!-- TICKET PROPERTIES ROW -->
              <div class="td-props" id="tdProps">
                <span class="prop-chip" id="propCategory"></span>
                <span class="prop-chip" id="propSource"></span>
                <span class="prop-chip" id="propCreated"></span>
                <span class="prop-chip merged-chip" id="propMerged" style="display:none">ðŸ”— Merged ticket</span>
              </div>
            </div>

            <!-- Drag handle: resize header height -->
            <div class="td-header-resizer" id="headerResizer"></div>

            <!-- MESSAGE THREAD -->
            <div class="td-thread" id="ticketThread"></div>

            <!-- DRAG HANDLE: thread â†” reply -->
            <div class="resizer resizer-h" id="resizerTR" title="Drag to resize"></div>

            <!-- REPLY BOX -->
            <div class="td-reply" id="tdReply">
              <div class="reply-tabs">
                <button class="reply-tab active" data-tab="reply">Reply</button>
                <button class="reply-tab" data-tab="note">Internal Note</button>
              </div>
              <div class="reply-editor-wrap">
                <div id="ticketReplyEditor" class="reply-quill"></div>
              </div>
              <div class="reply-actions">
                <div class="reply-actions-left">
                  <button class="reply-submit" id="sendReplyBtn">Send Reply</button>
                </div>
                <button class="reply-toggle" id="replyToggle" title="Minimize / Maximize reply box">âŒƒ</button>
              </div>
            </div>

          </div>
        </div>

        <!-- DRAG HANDLE: detail â†” sidebar -->
        <div class="resizer" id="resizerDS" title="Drag to resize"></div>

        <!-- â”€â”€ PANEL C: Ticket Sidebar (Properties) â”€â”€ -->
        <div class="panel panel-sidebar" id="panelSidebar">
          <div class="ts-section">
            <h4 class="ts-heading">Requester</h4>
            <div class="ts-field" id="sidebarRequester">â€”</div>
          </div>
          <div class="ts-section">
            <h4 class="ts-heading">Contact Info</h4>
            <div class="ts-field" id="sidebarEmail">â€”</div>
          </div>
          <div class="ts-section">
            <h4 class="ts-heading">Category</h4>
            <div class="ts-field" id="sidebarCategory">â€”</div>
          </div>
          <div class="ts-section">
            <h4 class="ts-heading">Source</h4>
            <div class="ts-field" id="sidebarSource">â€”</div>
          </div>
          <div class="ts-section">
            <h4 class="ts-heading">Created</h4>
            <div class="ts-field" id="sidebarCreated">â€”</div>
          </div>
          <div class="ts-section">
            <h4 class="ts-heading">Last Updated</h4>
            <div class="ts-field" id="sidebarUpdated">â€”</div>
          </div>
          <div class="ts-section" id="mergedSection" style="display:none">
            <h4 class="ts-heading">Merged From</h4>
            <div class="ts-field" id="sidebarMerged">â€”</div>
          </div>

          <!-- REQUESTER'S OTHER TICKETS -->
          <div class="ts-section">
            <h4 class="ts-heading">Other Tickets by Requester</h4>
            <div id="sidebarOtherTickets" class="ts-other-tickets">â€”</div>
          </div>
        </div>

      </div><!-- /workspace -->

    </main>
  </div>
</div>

<!-- MERGE MODAL -->
<div class="modal-overlay" id="mergeOverlay" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <h3>Merge Tickets</h3>
      <button class="modal-close" id="mergeClose">âœ•</button>
    </div>
    <p class="modal-sub">Select the ticket to merge <strong>into</strong>. The other ticket will be closed and its messages moved here.</p>
    <input type="text" id="mergeSearch" class="tb-search" placeholder="Search by name, email or subjectâ€¦" style="margin:12px 0;width:100%"/>
    <div id="mergeList" class="merge-list"></div>
    <div class="modal-footer">
      <button class="tb-btn" id="mergeCancelBtn">Cancel</button>
      <button class="tb-btn tb-btn-primary" id="mergeConfirmBtn" disabled>Merge</button>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
<script type="module" src="firebase.js"></script>
<script type="module" src="tickets.js"></script>

<script>
/* â”€â”€ Quill init (called from tickets.js) â”€â”€ */
let ticketQuill = null;
let replyMode   = "reply"; // "reply" | "note"

window.initTicketQuill = function () {
  const el = document.getElementById("ticketReplyEditor");
  if (!el || typeof Quill === "undefined") return;
  if (ticketQuill) { ticketQuill.setContents([]); return; }
  ticketQuill = new Quill(el, {
    theme: "snow",
    placeholder: "Write your responseâ€¦",
    modules: {
      toolbar: [
        ["bold","italic","underline"],
        [{ list:"ordered" },{ list:"bullet" }],
        ["link","blockquote"],
        ["clean"]
      ]
    }
  });
};

window.getTicketReplyHTML  = () => ticketQuill ? ticketQuill.root.innerHTML : "";
window.clearTicketReply    = () => { if (ticketQuill) ticketQuill.setContents([]); };
window.getReplyMode        = () => replyMode;

/* Reply tab switching */
document.addEventListener("click", e => {
  const tab = e.target.closest(".reply-tab");
  if (!tab) return;
  document.querySelectorAll(".reply-tab").forEach(t => t.classList.remove("active"));
  tab.classList.add("active");
  replyMode = tab.dataset.tab;
  const editor = document.getElementById("ticketReplyEditor");
  if (editor) {
    editor.style.background = replyMode === "note" ? "#fffbec" : "#fff";
  }
});

/* Reply box minimize / maximize */
let replyMinimized = false;
document.addEventListener("click", e => {
  if (!e.target.closest("#replyToggle")) return;
  const reply = document.getElementById("tdReply");
  const btn   = document.getElementById("replyToggle");
  replyMinimized = !replyMinimized;
  reply.classList.toggle("minimized", replyMinimized);
  btn.textContent = replyMinimized ? "âŒ„" : "âŒƒ";
  btn.title       = replyMinimized ? "Maximize reply box" : "Minimize reply box";
});
</script>

</body>
</html>
